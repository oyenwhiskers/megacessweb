<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MegaCess Web â€¢ Manage Attendance</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/megacessweb/assets/css/style.css">
  <link rel="stylesheet" href="/megacessweb/assets/css/manaageattendance.css">
  <style>
    /* Custom scrollbar for overtime list */
    #overtimeList::-webkit-scrollbar {
      width: 6px;
    }
    
    #overtimeList::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    
    #overtimeList::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }
    
    #overtimeList::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }
    
    /* Ensure smooth scrolling */
    #overtimeList {
      scroll-behavior: smooth;
    }
  </style>
</head>
<body data-page="manage-attendance">
  <div class="app d-flex">
    <aside class="sidebar p-3" id="sidebar-root"></aside>

    <main class="content flex-grow-1">
      <div class="topbar py-3 px-3 d-flex align-items-center justify-content-between">
        <h1 class="page-title h5 mb-0">Manage Attendance</h1>
        <button class="btn btn-outline-light d-lg-none" id="sidebarToggle"><i class="bi bi-list"></i></button>
      </div>
      <div class="container-fluid p-4">
        <!-- attendance type toggle -->
        <div class="mb-3">
          <div id="attendanceTypeToggle" class="btn-group" role="group" aria-label="Attendance type toggle">
            <button type="button" class="btn btn-outline-primary active" data-type="workers">Workers</button>
            <button type="button" class="btn btn-outline-primary" data-type="staff">Staff</button>
          </div>

          <!-- search bar below the toggle buttons -->
          <div class="mt-3 d-flex justify-content-start">
            <div class="input-group search-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input id="attendanceSearch" type="search" class="form-control" placeholder="Search by name..." aria-label="Search attendance">
              <button class="btn btn-outline-secondary" type="button" id="clearAttendanceSearch" title="Clear"><i class="bi bi-x-lg"></i></button>
            </div>
          </div>

          <!-- Date filter -->
          <div class="mt-2 d-flex align-items-center gap-3">
            <div>
              <label class="form-label mb-1">Date:</label>
              <input type="date" id="attendanceDate" class="form-control" value="">
            </div>
            <div>
              <label class="form-label mb-1">Status:</label>
              <select id="attendanceStatus" class="form-select">
                <option value="all">All Status</option>
                <option value="present">Present</option>
                <option value="absent">Absent</option>
                <option value="check_in">Check In</option>
                <option value="late">Late</option>
                <option value="annual_leave">Annual Leave</option>
                <option value="sick_leave">Sick Leave</option>
                <option value="unpaid_leave">Unpaid Leave</option>
              </select>
            </div>
          </div>
        </div>

        <!-- content views -->
        <div id="workersAttendanceView" class="view">
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading worker attendance...</p>
          </div>
        </div>

        <div id="staffAttendanceView" class="view d-none">
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading staff attendance...</p>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- Add Overtime Modal -->
  <div class="modal fade" id="addOvertimeModal" tabindex="-1" aria-labelledby="addOvertimeModalLabel" aria-hidden="true" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="background-color: #f8f9fa; border: none; border-radius: 15px;">
        <div class="modal-header border-0 pb-0">
          <button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Close" style="z-index: 1070;"></button>
        </div>
        <div class="modal-body px-4 py-3">
          <!-- Back Arrow and Title -->
          <div class="d-flex align-items-center mb-4">
            <button type="button" class="btn btn-link p-0 me-3" data-bs-dismiss="modal" style="color: #6c757d;">
              <i class="bi bi-arrow-left" style="font-size: 1.2rem;"></i>
            </button>
            <div>
              <h5 class="mb-1 fw-bold text-dark">Add new Overtime Record</h5>
              <p class="mb-0 text-muted small">Insert the required details with the correct information</p>
            </div>
          </div>

          <!-- Form -->
          <form id="addOvertimeForm">
            <!-- Overtime Date -->
            <div class="mb-4">
              <label class="form-label fw-semibold text-dark mb-2">Overtime Date:</label>
              <div class="position-relative">
                <input type="date" id="overtimeDate" class="form-control py-3" style="background-color: white; border: 1px solid #dee2e6; border-radius: 8px; padding-right: 3rem;" placeholder="Select start date..">
                <i class="bi bi-calendar3 position-absolute end-0 top-50 translate-middle-y me-3" style="color: #6c757d; pointer-events: none;"></i>
              </div>
            </div>

            <!-- Duration -->
            <div class="mb-4">
              <label class="form-label fw-semibold text-dark mb-2">Duration (hour):</label>
              <input type="number" id="overtimeDuration" class="form-control py-3" style="background-color: white; border: 1px solid #dee2e6; border-radius: 8px;" placeholder="Enter duration.." min="0" step="0.5">
            </div>

            <!-- Remarks -->
            <div class="mb-4">
              <label class="form-label fw-semibold text-dark mb-2">Remarks:</label>
              <textarea id="overtimeRemarks" class="form-control" rows="5" style="background-color: white; border: 1px solid #dee2e6; border-radius: 8px; resize: none;" placeholder="Enter remarks.."></textarea>
            </div>

            <!-- Save Button -->
            <div class="d-flex justify-content-end mt-4">
              <button type="submit" class="btn btn-dark px-4 py-2 d-flex align-items-center" style="border-radius: 8px;">
                <i class="bi bi-floppy me-2"></i>
                Save
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Manage Overtime Modal -->
  <div class="modal fade" id="manageOvertimeModal" tabindex="-1" aria-labelledby="manageOvertimeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background-color: #d4edda; border-bottom: none;">
          <h5 class="modal-title fw-bold text-dark" id="manageOvertimeModalLabel">Manage Overtime</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" style="background-color: #d4edda; padding: 0;">
          <!-- User Info Section -->
          <div class="mx-3 mb-3">
            <div class="bg-white rounded p-3 d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center">
                <div style="width: 60px; height: 60px;" class="me-3">
                  <img id="overtimeUserAvatar" src="" alt="User Avatar" class="rounded-circle" style="width: 60px; height: 60px; object-fit: cover; background-color: #333;">
                </div>
                <div>
                  <h6 class="mb-1 fw-bold" id="overtimeUserName">Loading...</h6>
                  <p class="mb-0 text-muted" id="overtimeUserRole">Loading...</p>
                </div>
              </div>
              <button type="button" class="btn btn-success btn-sm" id="addOvertimeBtn">
                <i class="bi bi-plus-circle me-1"></i>Add overtime
              </button>
            </div>
          </div>

          <!-- Filter Section -->
          <div class="mx-3 mb-3">
            <div class="d-flex gap-2">
              <button class="btn btn-light active" id="overtimeFilterAll">All</button>
              <div class="dropdown">
                <button class="btn btn-light dropdown-toggle" type="button" id="overtimeFilterMonth" data-bs-toggle="dropdown" aria-expanded="false">
                  Month
                </button>
                <ul class="dropdown-menu" aria-labelledby="overtimeFilterMonth">
                  <li><a class="dropdown-item" href="#" data-month="1">January</a></li>
                  <li><a class="dropdown-item" href="#" data-month="2">February</a></li>
                  <li><a class="dropdown-item" href="#" data-month="3">March</a></li>
                  <li><a class="dropdown-item" href="#" data-month="4">April</a></li>
                  <li><a class="dropdown-item" href="#" data-month="5">May</a></li>
                  <li><a class="dropdown-item" href="#" data-month="6">June</a></li>
                  <li><a class="dropdown-item" href="#" data-month="7">July</a></li>
                  <li><a class="dropdown-item" href="#" data-month="8">August</a></li>
                  <li><a class="dropdown-item" href="#" data-month="9">September</a></li>
                  <li><a class="dropdown-item" href="#" data-month="10">October</a></li>
                  <li><a class="dropdown-item" href="#" data-month="11">November</a></li>
                  <li><a class="dropdown-item" href="#" data-month="12">December</a></li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Overtime List Section -->
          <div class="mx-3">
            <h6 class="mb-3 text-dark">List of existing overtime:</h6>
            <div id="overtimeList" class="mb-3" style="max-height: 400px; overflow-y: auto; padding-right: 8px;">
              <!-- Overtime entries will be loaded here -->
              <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading overtime records...</p>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer" style="background-color: #d4edda; border-top: none;">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Overtime Modal -->
  <div class="modal fade" id="editOvertimeModal" tabindex="-1" aria-labelledby="editOvertimeModalLabel" aria-hidden="true" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="background-color: #f8f9fa; border: none; border-radius: 15px;">
        <div class="modal-header border-0 pb-0">
          <button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Close" style="z-index: 1070;"></button>
        </div>
        <div class="modal-body px-4 py-3">
          <!-- Back Arrow and Title -->
          <div class="d-flex align-items-center mb-4">
            <button type="button" class="btn btn-link p-0 me-3" data-bs-dismiss="modal" style="color: #6c757d;">
              <i class="bi bi-arrow-left" style="font-size: 1.2rem;"></i>
            </button>
            <div>
              <h5 class="mb-1 fw-bold text-dark">Edit Overtime Record</h5>
              <p class="mb-0 text-muted small">Update the overtime details with the correct information</p>
            </div>
          </div>

          <!-- Form -->
          <form id="editOvertimeForm">
            <!-- Hidden field for record ID -->
            <input type="hidden" id="editOvertimeId" value="">
            
            <!-- Overtime Date -->
            <div class="mb-4">
              <label class="form-label fw-semibold text-dark mb-2">Overtime Date:</label>
              <div class="position-relative">
                <input type="date" id="editOvertimeDate" class="form-control py-3" style="background-color: white; border: 1px solid #dee2e6; border-radius: 8px; padding-right: 3rem;" placeholder="Select start date..">
                <i class="bi bi-calendar3 position-absolute end-0 top-50 translate-middle-y me-3" style="color: #6c757d; pointer-events: none;"></i>
              </div>
            </div>

            <!-- Duration -->
            <div class="mb-4">
              <label class="form-label fw-semibold text-dark mb-2">Duration (hour):</label>
              <input type="number" id="editOvertimeDuration" class="form-control py-3" style="background-color: white; border: 1px solid #dee2e6; border-radius: 8px;" placeholder="Enter duration.." min="0" step="0.5">
            </div>

            <!-- Remarks -->
            <div class="mb-4">
              <label class="form-label fw-semibold text-dark mb-2">Remarks:</label>
              <textarea id="editOvertimeRemarks" class="form-control" rows="5" style="background-color: white; border: 1px solid #dee2e6; border-radius: 8px; resize: none;" placeholder="Enter remarks.."></textarea>
            </div>

            <!-- Save Button -->
            <div class="d-flex justify-content-end mt-4">
              <button type="submit" class="btn btn-dark px-4 py-2 d-flex align-items-center" style="border-radius: 8px;">
                <i class="bi bi-floppy me-2"></i>
                Update
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Manage Leave Modal -->
  <div class="modal fade" id="manageLeaveModal" tabindex="-1" aria-labelledby="manageLeaveModalLabel">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background-color: #d4edda; border-bottom: none;">
          <h5 class="modal-title fw-bold text-dark" id="manageLeaveModalLabel">Manage Leave</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" style="background-color: #d4edda; padding: 0;">
          <!-- User Info Section -->
          <div class="mx-3 mb-3">
            <div class="bg-white rounded p-3 d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center">
                <div style="width: 60px; height: 60px;" class="me-3">
                  <img id="leaveUserAvatar" src="" alt="User Avatar" class="rounded-circle" style="width: 60px; height: 60px; object-fit: cover; background-color: #333;">
                </div>
                <div>
                  <h6 class="mb-1 fw-bold" id="leaveUserName">Loading...</h6>
                  <p class="mb-0 text-muted" id="leaveUserRole">Loading...</p>
                </div>
              </div>
              <button type="button" class="btn btn-success btn-sm" id="addLeaveBtn">
                <i class="bi bi-plus-circle me-1"></i>Add new Leave
              </button>
            </div>
          </div>

          <!-- Filter Section -->
          <div class="mx-3 mb-3">
            <div class="d-flex gap-2">
              <button class="btn btn-light active" id="leaveFilterAll">All</button>
              <div class="dropdown">
                <button class="btn btn-light dropdown-toggle" type="button" id="leaveFilterMonth" data-bs-toggle="dropdown" aria-expanded="false">
                  Month
                </button>
                <ul class="dropdown-menu" aria-labelledby="leaveFilterMonth">
                  <li><a class="dropdown-item" href="#" data-month="1">January</a></li>
                  <li><a class="dropdown-item" href="#" data-month="2">February</a></li>
                  <li><a class="dropdown-item" href="#" data-month="3">March</a></li>
                  <li><a class="dropdown-item" href="#" data-month="4">April</a></li>
                  <li><a class="dropdown-item" href="#" data-month="5">May</a></li>
                  <li><a class="dropdown-item" href="#" data-month="6">June</a></li>
                  <li><a class="dropdown-item" href="#" data-month="7">July</a></li>
                  <li><a class="dropdown-item" href="#" data-month="8">August</a></li>
                  <li><a class="dropdown-item" href="#" data-month="9">September</a></li>
                  <li><a class="dropdown-item" href="#" data-month="10">October</a></li>
                  <li><a class="dropdown-item" href="#" data-month="11">November</a></li>
                  <li><a class="dropdown-item" href="#" data-month="12">December</a></li>
                </ul>
              </div>
              <div class="dropdown">
                <button class="btn btn-light dropdown-toggle" type="button" id="leaveFilterType" data-bs-toggle="dropdown" aria-expanded="false">
                  Type of Leave
                </button>
                <ul class="dropdown-menu" aria-labelledby="leaveFilterType">
                  <li><a class="dropdown-item" href="#" data-type="annual">Annual Leave</a></li>
                  <li><a class="dropdown-item" href="#" data-type="sick">Sick Leave</a></li>
                  <li><a class="dropdown-item" href="#" data-type="unpaid">Unpaid Leave</a></li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Leave List Section -->
          <div class="mx-3">
            <h6 class="mb-3 text-dark">List of applied leaves:</h6>
            <div id="leaveList" class="mb-3" style="max-height: 400px; overflow-y: auto; padding-right: 8px;">
              <!-- Leave entries will be loaded here -->
              <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading leave records...</p>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer" style="background-color: #d4edda; border-top: none;">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Leave Modal -->
  <div class="modal fade" id="addLeaveModal" tabindex="-1" aria-labelledby="addLeaveModalLabel" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="background-color: #f8f9fa; border: none; border-radius: 15px;">
        <div class="modal-header border-0 pb-0">
          <button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Close" style="z-index: 1070;"></button>
        </div>
        <div class="modal-body px-4 py-3">
          <!-- Back Arrow and Title -->
          <div class="d-flex align-items-center mb-4">
            <button type="button" class="btn btn-link p-0 me-3" data-bs-dismiss="modal" style="color: #6c757d;">
              <i class="bi bi-arrow-left" style="font-size: 1.2rem;"></i>
            </button>
            <div>
              <h5 class="mb-1 fw-bold text-dark">Apply for Leave</h5>
              <p class="mb-0 text-muted small">Fill in the details for your leave request</p>
            </div>
          </div>

          <!-- Form -->
          <form id="addLeaveForm">
            <!-- Leave Type -->
            <div class="mb-4">
              <label class="form-label fw-semibold text-dark mb-2">Leave Type:</label>
              <select id="leaveType" class="form-select py-3" style="background-color: white; border: 1px solid #dee2e6; border-radius: 8px;" required>
                <option value="">Select leave type...</option>
                <option value="annual_leave">Annual Leave</option>
                <option value="sick_leave">Sick Leave</option>
                <option value="unpaid_leave">Unpaid Leave</option>
              </select>
            </div>

            <!-- From Date -->
            <div class="mb-4">
              <label class="form-label fw-semibold text-dark mb-2">From Date:</label>
              <div class="position-relative">
                <input type="date" id="leaveFromDate" class="form-control py-3" style="background-color: white; border: 1px solid #dee2e6; border-radius: 8px; padding-right: 3rem;" required>
                <i class="bi bi-calendar3 position-absolute end-0 top-50 translate-middle-y me-3" style="color: #6c757d; pointer-events: none;"></i>
              </div>
            </div>

            <!-- To Date -->
            <div class="mb-4">
              <label class="form-label fw-semibold text-dark mb-2">To Date:</label>
              <div class="position-relative">
                <input type="date" id="leaveToDate" class="form-control py-3" style="background-color: white; border: 1px solid #dee2e6; border-radius: 8px; padding-right: 3rem;" required>
                <i class="bi bi-calendar3 position-absolute end-0 top-50 translate-middle-y me-3" style="color: #6c757d; pointer-events: none;"></i>
              </div>
            </div>

            <!-- Notes -->
            <div class="mb-4">
              <label class="form-label fw-semibold text-dark mb-2">Notes (Optional):</label>
              <textarea id="leaveNotes" class="form-control" rows="4" style="background-color: white; border: 1px solid #dee2e6; border-radius: 8px; resize: none;" placeholder="Enter reason or additional notes..."></textarea>
            </div>

            <!-- Submit Button -->
            <div class="d-flex justify-content-end mt-4">
              <button type="submit" class="btn btn-success px-4 py-2 d-flex align-items-center" style="border-radius: 8px;">
                <i class="bi bi-calendar-plus me-2"></i>
                Submit Leave Request
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>


  <!-- View Attendance Modal -->
  <div class="modal fade" id="viewAttendanceModal" tabindex="-1" aria-labelledby="viewAttendanceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" style="background: #d4f8d4; border-radius: 16px;">
        <div class="modal-header" style="border-bottom: none; background: #d4f8d4;">
          <h5 class="modal-title fw-bold" id="viewAttendanceModalLabel">Manage Attendance &gt; View Attendance</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" style="background: #d4f8d4;">
          <div class="d-flex align-items-center mb-3" style="background: #fff; border-radius: 12px; padding: 16px;">
            <img class="worker-avatar rounded-circle me-3" src="https://ui-avatars.com/api/?name=User&background=cccccc&color=fff&size=96" alt="Avatar" style="width: 64px; height: 64px; object-fit: cover;">
            <div>
              <div class="worker-name fw-bold" style="font-size: 1.25rem;">User</div>
              <div class="worker-role text-muted"></div>
            </div>
          </div>
          <div class="mb-3">
            <div class="d-flex gap-2 align-items-center">
              <select class="form-select w-auto attendance-year-select" style="min-width: 100px;">
                <option>2023</option>
                <option>2024</option>
                <option selected>2025</option>
              </select>
              <select class="form-select w-auto attendance-month-select" style="min-width: 160px;">
                <option>January</option>
                <option>February</option>
                <option>March</option>
                <option>April</option>
                <option>May</option>
                <option>June</option>
                <option>July</option>
                <option>August</option>
                <option>September</option>
                <option>October</option>
                <option>November</option>
                <option selected>December</option>
              </select>
            </div>
          </div>
          <div class="row g-3">
            <div class="col-md-4">
              <div class="card shadow-sm" style="border-radius: 12px;">
                <div class="card-body text-center p-3">
                  <div class="text-muted mb-1" style="font-size: 1rem;">Attendance Rate</div>
                  <div id="attendanceRateValue" class="fw-bold" style="font-size: 2rem; color: #176c2f;">...</div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card shadow-sm" style="border-radius: 12px;">
                <div class="card-body text-center p-3">
                  <div class="text-muted mb-1" style="font-size: 1rem;">Punctuality Rate</div>
                  <div id="punctualityRateValue" class="fw-bold" style="font-size: 2rem; color: #176c2f;">...</div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card shadow-sm" style="border-radius: 12px;">
                <div class="card-body text-center p-3">
                  <div class="text-muted mb-1" style="font-size: 1rem;">Number of days absence</div>
                  <div id="numberAbsentValue" class="fw-bold" style="font-size: 2rem; color: #176c2f;">...</div>
                </div>
              </div>
            </div>
          </div>
          <!-- Static attendance status list -->
          <!-- Removed attendance status list display below analytics -->

          <!-- Add below analytics cards in View Attendance modal -->
          <!-- Attendance Records Filter -->
          <div id="attendanceRecordsList" class="mt-4">
            <h6 class="fw-bold mb-2">Attendance Records</h6>
            <div class="d-flex gap-2 align-items-center mb-2">
              <select class="form-select w-auto attendance-records-year-select" style="min-width: 100px;">
                <option>2023</option>
                <option>2024</option>
                <option selected>2025</option>
              </select>
              <select class="form-select w-auto attendance-records-month-select" style="min-width: 160px;">
                <option>January</option>
                <option>February</option>
                <option>March</option>
                <option>April</option>
                <option>May</option>
                <option>June</option>
                <option>July</option>
                <option>August</option>
                <option>September</option>
                <option>October</option>
                <option>November</option>
                <option selected>December</option>
              </select>
              <select class="form-select w-auto attendance-records-status-select" style="min-width: 140px;">
                <option value="all">All Status</option>
                <option value="present">Present</option>
                <option value="absent">Absent</option>
                <option value="late">Late</option>
                <option value="annual_leave">Annual Leave</option>
                <option value="sick_leave">Sick Leave</option>
                <option value="unpaid_leave">Unpaid Leave</option>
              </select>
            </div>
            <div id="attendanceRecordsTable" class="table-responsive"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/megacessweb/assets/js/main.js"></script>
  <script src="/megacessweb/assets/js/manage_overtime.js?v=1.0"></script>
  <script src="/megacessweb/assets/js/manage_leave.js?v=1.0"></script>
  <script src="/megacessweb/assets/js/list_workers_att.js?v=1.7"></script>
  <script src="/megacessweb/assets/js/list_staff_att.js?v=1.3"></script>
  <script src="/megacessweb/assets/js/logout.js"></script>
  <script>
    // Ensure this function is defined before window.viewAttendanceDetails
    function updateAttendanceAnalyticsByMonth(staffId) {
      var modalEl = document.getElementById('viewAttendanceModal');
      var monthSelect = modalEl.querySelector('.attendance-month-select');
      var yearSelect = modalEl.querySelector('.attendance-year-select');
      var selectedMonth = '';
      var selectedYear = '';
      // Month mapping
      var monthMap = {
        'January': 1,
        'February': 2,
        'March': 3,
        'April': 4,
        'May': 5,
        'June': 6,
        'July': 7,
        'August': 8,
        'September': 9,
        'October': 10,
        'November': 11,
        'December': 12
      };
      if (yearSelect && yearSelect.value !== 'Year') {
        selectedYear = yearSelect.value;
      } else {
        selectedYear = new Date().getFullYear();
      }
      if (monthSelect) {
        var val = monthSelect.value;
        if (val && val !== 'Month' && monthMap[val]) {
          var monthNum = monthMap[val];
          selectedMonth = `${selectedYear}-${String(monthNum).padStart(2,'0')}`;
        } else {
          selectedMonth = `${selectedYear}-${String(new Date().getMonth()+1).padStart(2,'0')}`;
        }
      }
      fetchAttendanceAnalytics(staffId, selectedMonth).then(analytics => {
        if (analytics) {
          document.getElementById('attendanceRateValue').textContent = analytics.attendance_rate + '%';
          document.getElementById('punctualityRateValue').textContent = analytics.punctuality_rate + '%';
          document.getElementById('numberAbsentValue').textContent = analytics.number_absent;
        } else {
          document.getElementById('attendanceRateValue').textContent = 'N/A';
          document.getElementById('punctualityRateValue').textContent = 'N/A';
          document.getElementById('numberAbsentValue').textContent = 'N/A';
        }
      });
    }

    async function fetchAttendanceAnalytics(staffId, month) {
      const token = localStorage.getItem('authToken') || localStorage.getItem('auth_token') || sessionStorage.getItem('authToken') || sessionStorage.getItem('auth_token') || '';
      if (!token) return null;
      const now = new Date();
      const monthStr = month || `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      try {
        const response = await fetch(`https://mwms.megacess.com/api/v1/staff-attendance/${staffId}/analytics?month=${monthStr}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          }
        });
        if (!response.ok) return null;
        const data = await response.json();
        return data && data.data ? data.data : null;
      } catch (e) {
        return null;
      }
    }

    async function fetchWorkerInfo(staffId) {
      const token = localStorage.getItem('authToken') || localStorage.getItem('auth_token') || sessionStorage.getItem('authToken') || sessionStorage.getItem('auth_token') || '';
      if (!token) return null;
      try {
        const response = await fetch(`https://mwms.megacess.com/api/v1/staff/${staffId}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          }
        });
        if (!response.ok) return null;
        const data = await response.json();
        return data && data.data ? data.data : null;
      } catch (e) {
        return null;
      }
    }

    // Fetch and display attendance records for workers
    async function fetchWorkerAttendanceRecords(workerId, month) {
      const token = localStorage.getItem('authToken') || localStorage.getItem('auth_token') || sessionStorage.getItem('authToken') || sessionStorage.getItem('auth_token') || '';
      if (!token) return [];
      let url = `https://mwms.megacess.com/api/v1/staff-attendance/${workerId}/records`;
      if (month) {
        url += `?month=${month}`;
      }
      try {
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          }
        });
        if (!response.ok) return [];
        const data = await response.json();
        return data && data.data && data.data.data ? data.data.data : [];
      } catch (e) {
        return [];
      }
    }

    function getStatusBadge(status) {
      switch (status) {
        case 'Present':
          return '<span class="badge" style="background:#198754;color:#fff;font-weight:500;font-size:1rem;"><i class="bi bi-check2 me-1"></i>Present</span>';
        case 'Absent':
          return '<span class="badge" style="background:#dc3545;color:#fff;font-weight:500;font-size:1rem;"><i class="bi bi-x-lg me-1"></i>Absent</span>';
        case 'Late':
          return '<span class="badge" style="background:#a86b32;color:#fff;font-weight:500;font-size:1rem;"><i class="bi bi-alarm me-1"></i>Late</span>';
        case 'Annual Leave':
        case 'annual_leave':
          return '<span class="badge" style="background:#0d6efd;color:#fff;font-weight:500;font-size:1rem;"><i class="bi bi-calendar2-week me-1"></i>Annual Leave</span>';
        case 'Sick Leave':
        case 'sick_leave':
          return '<span class="badge" style="background:#0dcaf0;color:#fff;font-weight:500;font-size:1rem;"><i class="bi bi-thermometer-half me-1"></i>Sick Leave</span>';
        case 'Unpaid Leave':
        case 'unpaid_leave':
          return '<span class="badge" style="background:#e6bfc0;color:#b94a48;font-weight:500;font-size:1rem;"><i class="bi bi-calendar-x me-1"></i>Unpaid Leave</span>';
        case 'Check_in':
          return '<span class="badge" style="background:#6c757d;color:#fff;font-weight:500;font-size:1rem;"><i class="bi bi-box-arrow-in-right me-1"></i>Check In</span>';
        default:
          return `<span class="badge bg-secondary" style="font-weight:500;font-size:1rem;">${status}</span>`;
      }
    }

    function getStatusBorderColor(status) {
      switch (status) {
        case 'Present': return '#198754';
        case 'Absent': return '#dc3545';
        case 'Late': return '#a86b32';
        case 'Annual Leave':
        case 'annual_leave': return '#0d6efd';
        case 'Sick Leave':
        case 'sick_leave': return '#0dcaf0';
        case 'Unpaid Leave':
        case 'unpaid_leave': return '#b94a48';
        case 'Check_in': return '#6c757d';
        default: return '#6c757d';
      }
    }

    function renderAttendanceRecordsTable(records) {
      const tableDiv = document.getElementById('attendanceRecordsTable');
      if (!tableDiv) return;
      if (!records || records.length === 0) {
        tableDiv.innerHTML = '<div class="text-muted">No attendance records found for this month.</div>';
        return;
      }
      // Filter records by allowed statuses
      const allowedStatuses = [
        'Present',
        'Absent',
        'Late',
        'Annual Leave',
        'annual_leave',
        'Unpaid Leave',
        'unpaid_leave',
        'Sick Leave',
        'sick_leave',
        'Sick Leave (MC)',
        'MC'
      ];
      const filteredRecords = records.filter(r => allowedStatuses.includes(r.status));
      if (filteredRecords.length === 0) {
        tableDiv.innerHTML = '<div class="text-muted">No attendance records found for this month.</div>';
        return;
      }
      let html = '<div class="attendance-records-list" style="max-height: 370px; overflow-y: auto;">';
      filteredRecords.forEach(r => {
        let borderColor = getStatusBorderColor(r.status);
        html += `<div class="attendance-record-card d-flex align-items-center justify-content-between mb-2" style="border:1px solid #b6b6b6;border-left:16px solid ${borderColor};background:#fff;padding:0.75rem 1rem;min-height:56px;border-radius:6px;">
          <div class="fw-bold" style="font-size:1.15rem;">${r.date ? r.date.replace(/-/g,'/') : ''}</div>
          <div class="ms-auto">${getStatusBadge(r.status)}</div>
        </div>`;
      });
      html += '</div>';
      tableDiv.innerHTML = html;
    }

    window.viewAttendanceDetails = async function(staffId) {
      var modalEl = document.getElementById('viewAttendanceModal');
      var modal = new bootstrap.Modal(modalEl);
      modal.show();

      // Set default month and year for analytics filter
      var monthSelect = modalEl.querySelector('.attendance-month-select');
      var yearSelect = modalEl.querySelector('.attendance-year-select');
      var now = new Date();
      if (monthSelect) {
        var monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        monthSelect.selectedIndex = now.getMonth();
      }
      if (yearSelect) {
        for (var i = 0; i < yearSelect.options.length; i++) {
          if (yearSelect.options[i].value == now.getFullYear()) {
            yearSelect.selectedIndex = i;
            break;
          }
        }
      }

      // Set default month, year, and status for records filter (independent)
      var recMonthSelect = modalEl.querySelector('.attendance-records-month-select');
      var recYearSelect = modalEl.querySelector('.attendance-records-year-select');
      var recStatusSelect = modalEl.querySelector('.attendance-records-status-select');
      if (recMonthSelect) recMonthSelect.selectedIndex = now.getMonth();
      if (recYearSelect) {
        for (var i = 0; i < recYearSelect.options.length; i++) {
          if (recYearSelect.options[i].value == now.getFullYear()) {
            recYearSelect.selectedIndex = i;
            break;
          }
        }
      }
      if (recStatusSelect) recStatusSelect.value = 'all';

      // Fetch and display worker info
      const workerInfo = await fetchWorkerInfo(staffId);
      var nameEl = modalEl.querySelector('.worker-name');
      var roleEl = modalEl.querySelector('.worker-role');
      var avatarEl = modalEl.querySelector('.worker-avatar');
      if (workerInfo) {
        if (nameEl) nameEl.textContent = workerInfo.staff_fullname || 'Unknown';
        if (roleEl) roleEl.textContent = workerInfo.staff_role || '';
        if (avatarEl) {
          if (workerInfo.staff_img && typeof workerInfo.staff_img === 'string' && workerInfo.staff_img.trim() !== '') {
            let imgUrl = workerInfo.staff_img.replace(/:\d+$/, '').trim();
            if (!imgUrl.startsWith('http') && !imgUrl.startsWith('/')) {
              imgUrl = `https://mwms.megacess.com/storage/user-images/${imgUrl}`;
            } else if (imgUrl.startsWith('/')) {
              imgUrl = `https://mwms.megacess.com${imgUrl}`;
            }
            avatarEl.src = imgUrl;
            avatarEl.onerror = function() {
              this.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(workerInfo.staff_fullname || 'User')}&background=cccccc&color=fff&size=96`;
              this.onerror = null;
            };
          } else {
            avatarEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(workerInfo.staff_fullname || 'User')}&background=cccccc&color=fff&size=96`;
            avatarEl.onerror = null;
          }
        }
      } else {
        if (nameEl) nameEl.textContent = 'Unknown';
        if (roleEl) roleEl.textContent = '';
        if (avatarEl) avatarEl.src = `https://ui-avatars.com/api/?name=User&background=cccccc&color=fff&size=96`;
      }

      document.getElementById('attendanceRateValue').textContent = '...';
      document.getElementById('punctualityRateValue').textContent = '...';
      document.getElementById('numberAbsentValue').textContent = '...';

      updateAttendanceAnalyticsByMonth(staffId);

      // Fetch and render attendance records for workers
      async function updateRecords() {
        var recMonthSelect = modalEl.querySelector('.attendance-records-month-select');
        var recYearSelect = modalEl.querySelector('.attendance-records-year-select');
        var recStatusSelect = modalEl.querySelector('.attendance-records-status-select');
        var selectedYear = recYearSelect && recYearSelect.value !== 'Year' ? recYearSelect.value : new Date().getFullYear();
        var monthMap = {
          'January': 1,
          'February': 2,
          'March': 3,
          'April': 4,
          'May': 5,
          'June': 6,
          'July': 7,
          'August': 8,
          'September': 9,
          'October': 10,
          'November': 11,
          'December': 12
        };
        var selectedMonth = recMonthSelect && monthMap[recMonthSelect.value] ? String(monthMap[recMonthSelect.value]).padStart(2,'0') : String(new Date().getMonth()+1).padStart(2,'0');
        var monthStr = `${selectedYear}-${selectedMonth}`;
        const records = await fetchWorkerAttendanceRecords(staffId, monthStr);
        // Filter by status if not 'all'
        let filteredRecords = records;
        if (recStatusSelect && recStatusSelect.value !== 'all') {
          filteredRecords = records.filter(r => {
            // Normalize status for comparison
            let statusVal = recStatusSelect.value;
            if (statusVal === 'present') return r.status === 'Present';
            if (statusVal === 'absent') return r.status === 'Absent';
            if (statusVal === 'check_in') return r.status === 'Check_in';
            if (statusVal === 'late') return r.status === 'Late';
            if (statusVal === 'annual_leave') return r.status === 'Annual Leave' || r.status === 'annual_leave';
            if (statusVal === 'sick_leave') return r.status === 'Sick Leave' || r.status === 'sick_leave';
            if (statusVal === 'unpaid_leave') return r.status === 'Unpaid Leave' || r.status === 'unpaid_leave';
            return true;
          });
        }
        renderAttendanceRecordsTable(filteredRecords);
      }
      await updateRecords();

      // Add event listeners for records filter dropdowns (independent)
      if (recMonthSelect) recMonthSelect.onchange = updateRecords;
      if (recYearSelect) recYearSelect.onchange = updateRecords;
      if (recStatusSelect) recStatusSelect.onchange = updateRecords;

      // Add event listeners for analytics filter dropdowns (independent)
      if (monthSelect) monthSelect.onchange = function() { updateAttendanceAnalyticsByMonth(staffId); };
      if (yearSelect) yearSelect.onchange = function() { updateAttendanceAnalyticsByMonth(staffId); };
    };

    (function(){
      const buttons = document.querySelectorAll('#attendanceTypeToggle button');
      const views = {
        workers: document.getElementById('workersAttendanceView'),
        staff: document.getElementById('staffAttendanceView')
      };
      
      // Set today's date as default
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('attendanceDate').value = today;
      
      function show(type){
        // toggle active class on buttons
        buttons.forEach(b => b.classList.toggle('active', b.dataset.type === type));
        
        // show/hide views
        Object.keys(views).forEach(k => {
          const el = views[k];
          if (!el) return;
          if (k === type) el.classList.remove('d-none');
          else el.classList.add('d-none');
        });
        
        // Load attendance data based on type
        loadAttendanceData(type);
      }
      
      function loadAttendanceData(type) {
        const searchValue = document.getElementById('attendanceSearch').value;
        const dateValue = document.getElementById('attendanceDate').value;
        const statusValue = document.getElementById('attendanceStatus').value;
        
        if (type === 'workers' && window.fetchWorkerAttendanceList) {
          // Use the actual API for workers
          const dateAttendanceId = dateValue ? getDateAttendanceId(dateValue) : 1;
          window.fetchWorkerAttendanceList(searchValue, 1, dateAttendanceId, 10, statusValue);
        } else if (type === 'staff' && window.fetchStaffAttendanceList) {
          // Use the actual API for staff
          const dateAttendanceId = dateValue ? getDateAttendanceId(dateValue) : 1;
          window.fetchStaffAttendanceList(searchValue, 1, dateAttendanceId, 10, statusValue);
        }
      }
      
      // Helper function to convert date to date_attendance_id
      // This is a placeholder - you may need to adjust this based on your API's date handling
      function getDateAttendanceId(dateString) {
        if (!dateString) return 1;
        // For now, return 1 as default. You might need to call an API to get the proper ID
        // based on the selected date, or implement your own logic
        return 1;
      }
      
      // Search functionality
      const searchInput = document.getElementById('attendanceSearch');
      const dateInput = document.getElementById('attendanceDate');
      const statusSelect = document.getElementById('attendanceStatus');
      
      if (searchInput) {
        let debounceTimer = null;
        searchInput.addEventListener('input', function() {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => {
            const currentType = document.querySelector('#attendanceTypeToggle button.active').dataset.type;
            if (currentType === 'workers' && window.fetchWorkerAttendanceList) {
              const dateAttendanceId = dateInput.value ? getDateAttendanceId(dateInput.value) : 1;
              const statusValue = statusSelect.value;
              window.fetchWorkerAttendanceList(searchInput.value, 1, dateAttendanceId, 10, statusValue);
            } else if (currentType === 'staff' && window.fetchStaffAttendanceList) {
              const dateAttendanceId = dateInput.value ? getDateAttendanceId(dateInput.value) : 1;
              const statusValue = statusSelect.value;
              window.fetchStaffAttendanceList(searchInput.value, 1, dateAttendanceId, 10, statusValue);
            } else {
              loadAttendanceData(currentType);
            }
          }, 300);
        });
      }
      
      if (dateInput) {
        dateInput.addEventListener('change', function() {
          const currentType = document.querySelector('#attendanceTypeToggle button.active').dataset.type;
          if (currentType === 'workers' && window.fetchWorkerAttendanceList) {
            const dateAttendanceId = dateInput.value ? getDateAttendanceId(dateInput.value) : 1;
            const statusValue = statusSelect.value;
            window.fetchWorkerAttendanceList(searchInput.value, 1, dateAttendanceId, 10, statusValue);
          } else if (currentType === 'staff' && window.fetchStaffAttendanceList) {
            const dateAttendanceId = dateInput.value ? getDateAttendanceId(dateInput.value) : 1;
            const statusValue = statusSelect.value;
            window.fetchStaffAttendanceList(searchInput.value, 1, dateAttendanceId, 10, statusValue);
          } else {
            loadAttendanceData(currentType);
          }
        });
      }
      
      if (statusSelect) {
        statusSelect.addEventListener('change', function() {
          const currentType = document.querySelector('#attendanceTypeToggle button.active').dataset.type;
          if (currentType === 'workers' && window.fetchWorkerAttendanceList) {
            const dateAttendanceId = dateInput.value ? getDateAttendanceId(dateInput.value) : 1;
            window.fetchWorkerAttendanceList(searchInput.value, 1, dateAttendanceId, 10, statusSelect.value);
          } else if (currentType === 'staff' && window.fetchStaffAttendanceList) {
            const dateAttendanceId = dateInput.value ? getDateAttendanceId(dateInput.value) : 1;
            window.fetchStaffAttendanceList(searchInput.value, 1, dateAttendanceId, 10, statusSelect.value);
          } else {
            loadAttendanceData(currentType);
          }
        });
      }
      
      // Clear search functionality
      const clearSearch = document.getElementById('clearAttendanceSearch');
      if (clearSearch) {
        clearSearch.addEventListener('click', function() {
          searchInput.value = '';
          const currentType = document.querySelector('#attendanceTypeToggle button.active').dataset.type;
          if (currentType === 'workers' && window.fetchWorkerAttendanceList) {
            const dateAttendanceId = dateInput.value ? getDateAttendanceId(dateInput.value) : 1;
            const statusValue = statusSelect.value;
            window.fetchWorkerAttendanceList('', 1, dateAttendanceId, 10, statusValue);
          } else if (currentType === 'staff' && window.fetchStaffAttendanceList) {
            const dateAttendanceId = dateInput.value ? getDateAttendanceId(dateInput.value) : 1;
            const statusValue = statusSelect.value;
            window.fetchStaffAttendanceList('', 1, dateAttendanceId, 10, statusValue);
          } else {
            loadAttendanceData(currentType);
          }
        });
      }
      
      // Toggle event listeners
      buttons.forEach(b => b.addEventListener('click', () => show(b.dataset.type)));
      
      // Initial state
      show('workers');

      // Overtime Modal Functions
      window.showOvertimeModal = function(userId, userName, userRole, userImage, userType) {
        // Store current user context for filtering
        window.currentOvertimeUserId = userId;
        window.currentOvertimeUserType = userType;
        
        // Set user information
        document.getElementById('overtimeUserName').textContent = userName || 'Unknown User';
        document.getElementById('overtimeUserRole').textContent = userRole || 'Unknown Role';
        
        // Set user avatar with comprehensive error handling
        const avatar = document.getElementById('overtimeUserAvatar');
        
        // Clean and validate the image URL
        let cleanImageUrl = '';
        if (userImage && typeof userImage === 'string' && userImage.trim() !== '') {
          // Remove problematic suffixes like :1, :2, etc.
          cleanImageUrl = userImage.replace(/:\d+$/, '').trim();
          
          // Additional cleaning for malformed URLs
          cleanImageUrl = cleanImageUrl.replace(/\.jpg:.*$/, '.jpg');
          cleanImageUrl = cleanImageUrl.replace(/\.png:.*$/, '.png');
          cleanImageUrl = cleanImageUrl.replace(/\.jpeg:.*$/, '.jpeg');
          cleanImageUrl = cleanImageUrl.replace(/\.gif:.*$/, '.gif');
          
          // Check if the cleaned URL is still valid
          if (cleanImageUrl.length < 5 || 
              cleanImageUrl.includes('null') || 
              cleanImageUrl.includes('undefined') ||
              cleanImageUrl.includes('â€¦') || // Sometimes URLs get truncated with ellipsis
              cleanImageUrl.endsWith(':')) {
            cleanImageUrl = '';
          }
        }
        
        if (cleanImageUrl && cleanImageUrl.trim() !== '') {
          // Try to construct the full URL
          let imageSrc = cleanImageUrl;
          
          // If it's not a full URL, construct the proper path
          if (!cleanImageUrl.startsWith('http') && !cleanImageUrl.startsWith('/')) {
            imageSrc = `https://mwms.megacess.com/storage/user-images/${cleanImageUrl}`;
          } else if (cleanImageUrl.startsWith('/')) {
            imageSrc = `https://mwms.megacess.com${cleanImageUrl}`;
          }
          
          // Set the image with error fallback
          avatar.src = imageSrc;
          avatar.onerror = function() {
            // Fallback to placeholder if image fails to load
            const placeholderImage = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName || 'User')}&background=cccccc&color=fff&size=96`;
            this.src = placeholderImage;
            this.onerror = null; // Prevent infinite loop
          };
        } else {
          // Generate placeholder avatar for invalid or missing images
          const placeholderImage = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName || 'User')}&background=cccccc&color=fff&size=96`;
          avatar.src = placeholderImage;
          avatar.onerror = null; // Clear any previous error handler
        }
        
        // Reset filter buttons
        document.getElementById('overtimeFilterAll').classList.add('active');
        document.getElementById('overtimeFilterMonth').textContent = 'Month';
        
        // Load overtime data for this user using the real API
        if (window.loadUserOvertimeData) {
          window.loadUserOvertimeData(userId, userType);
        }
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('manageOvertimeModal'));
        modal.show();
      };

      // Leave Modal Functions
      window.showLeaveModal = function(userId, userName, userRole, userImage, userType) {
        console.log('showLeaveModal called with:', { userId, userName, userRole, userImage, userType });
        
        // Store current user context for filtering
        window.currentLeaveUserId = userId;
        window.currentLeaveUserType = userType;
        
        // Set user information with better debugging
        console.log('Setting user name to:', userName);
        console.log('Setting user role to:', userRole);
        
        const userNameElement = document.getElementById('leaveUserName');
        const userRoleElement = document.getElementById('leaveUserRole');
        
        if (userNameElement) {
          userNameElement.textContent = userName || 'Unknown User';
          console.log('User name element updated to:', userNameElement.textContent);
        } else {
          console.error('leaveUserName element not found');
        }
        
        if (userRoleElement) {
          userRoleElement.textContent = userRole || 'Unknown Role';
          console.log('User role element updated to:', userRoleElement.textContent);
        } else {
          console.error('leaveUserRole element not found');
        }
        
        // Set user avatar with comprehensive error handling
        const avatar = document.getElementById('leaveUserAvatar');
        
        // Clean and validate the image URL
        let cleanImageUrl = '';
        if (userImage && typeof userImage === 'string' && userImage.trim() !== '') {
          // Remove problematic suffixes like :1, :2, etc.
          cleanImageUrl = userImage.replace(/:\d+$/, '').trim();
          
          // Additional cleaning for malformed URLs
          cleanImageUrl = cleanImageUrl.replace(/\.jpg:.*$/, '.jpg');
          cleanImageUrl = cleanImageUrl.replace(/\.png:.*$/, '.png');
          cleanImageUrl = cleanImageUrl.replace(/\.jpeg:.*$/, '.jpeg');
          cleanImageUrl = cleanImageUrl.replace(/\.gif:.*$/, '.gif');
          
          // Check if the cleaned URL is still valid
          if (cleanImageUrl.length < 5 || 
              cleanImageUrl.includes('null') || 
              cleanImageUrl.includes('undefined') ||
              cleanImageUrl.includes('â€¦') || // Sometimes URLs get truncated with ellipsis
              cleanImageUrl.endsWith(':')) {
            cleanImageUrl = '';
          }
        }
        
        if (cleanImageUrl && cleanImageUrl.trim() !== '') {
          // Try to construct the full URL
          let imageSrc = cleanImageUrl;
          
          // If it's not a full URL, construct the proper path
          if (!cleanImageUrl.startsWith('http') && !cleanImageUrl.startsWith('/')) {
            imageSrc = `https://mwms.megacess.com/storage/user-images/${cleanImageUrl}`;
          } else if (cleanImageUrl.startsWith('/')) {
            imageSrc = `https://mwms.megacess.com${cleanImageUrl}`;
          }
          
          // Set the image with error fallback
          avatar.src = imageSrc;
          avatar.onerror = function() {
            // Fallback to placeholder if image fails to load
            const placeholderImage = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName || 'User')}&background=cccccc&color=fff&size=96`;
            this.src = placeholderImage;
            this.onerror = null; // Prevent infinite loop
          };
        } else {
          // Generate placeholder avatar for invalid or missing images
          const placeholderImage = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName || 'User')}&background=cccccc&color=fff&size=96`;
          avatar.src = placeholderImage;
          avatar.onerror = null; // Clear any previous error handler
        }
        
        // Reset filter buttons
        document.getElementById('leaveFilterAll').classList.add('active');
        document.getElementById('leaveFilterMonth').textContent = 'Month';
        document.getElementById('leaveFilterType').textContent = 'Type of Leave';
        
        // Load leave data for this user using the real API
        if (window.loadUserLeaveData) {
          window.loadUserLeaveData(userId, userType);
        } else {
          console.error('loadUserLeaveData function not found');
        }
        
        console.log('About to show leave modal...');
        
        // Show the modal - Bootstrap will handle aria-hidden automatically
        const modal = new bootstrap.Modal(document.getElementById('manageLeaveModal'));
        modal.show();
        
        console.log('Leave modal should now be visible');
      };

      // Add leave button functionality
      document.getElementById('addLeaveBtn').addEventListener('click', function() {
        // Show the add leave modal
        const addLeaveModal = new bootstrap.Modal(document.getElementById('addLeaveModal'));
        addLeaveModal.show();
        
        // Set today's date as default for from date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('leaveFromDate').value = today;
        document.getElementById('leaveToDate').value = today;
        
        // Clear form fields
        document.getElementById('leaveType').value = '';
        document.getElementById('leaveNotes').value = '';
      });

      // Add leave form submission
      document.getElementById('addLeaveForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const leaveType = document.getElementById('leaveType').value;
        const fromDate = document.getElementById('leaveFromDate').value;
        const toDate = document.getElementById('leaveToDate').value;
        const notes = document.getElementById('leaveNotes').value;
        
        // Validate form
        if (!leaveType) {
          alert('Please select a leave type');
          return;
        }
        
        if (!fromDate) {
          alert('Please select a from date');
          return;
        }
        
        if (!toDate) {
          alert('Please select a to date');
          return;
        }
        
        // Validate date range
        if (new Date(fromDate) > new Date(toDate)) {
          alert('From date cannot be later than to date');
          return;
        }
        
        // Get current user context
        const userId = window.currentLeaveUserId;
        const userType = window.currentLeaveUserType;
        
        console.log('Form submission - userId:', userId, 'userType:', userType);
        
        if (!userId || !userType) {
          alert('User context not found. Please close and reopen the leave modal.');
          return;
        }
        
        // Additional validation for user types
        if (!['worker', 'staff'].includes(userType)) {
          alert('Invalid user type. Please refresh and try again.');
          return;
        }
        
        console.log('Submitting leave request:', { userId, leaveType, fromDate, toDate, notes });
        
        // Call API to submit leave request
        submitLeaveRequest(userId, fromDate, toDate, leaveType, notes);
      });

      // Function to submit leave request via API
      async function submitLeaveRequest(staffId, fromDate, toDate, leaveType, notes) {
        const submitButton = document.querySelector('#addLeaveForm button[type="submit"]');
        
        try {
          // Validate that the submitLeaveApplication function exists
          if (typeof window.submitLeaveApplication !== 'function') {
            throw new Error('Leave management function not available. Please refresh the page.');
          }

          // Validate user context
          if (!window.currentLeaveUserId || !window.currentLeaveUserType) {
            throw new Error('User context not found. Please close and reopen the leave modal.');
          }

          // Show loading state
          const originalContent = submitButton.innerHTML;
          submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
          submitButton.disabled = true;

          console.log('Calling submitLeaveApplication with:', { staffId, fromDate, toDate, leaveType, notes });

          // Use the API function from manage_leave.js
          const result = await window.submitLeaveApplication(staffId, fromDate, toDate, leaveType, notes);

          console.log('Leave submission result:', result);

          // Validate result structure - check if it's an object and has required properties
          if (!result || typeof result !== 'object' || typeof result.success === 'undefined') {
            throw new Error('Invalid response from leave management system.');
          }

          if (result.success) {
            // Show success message
            const leaveTypeDisplayName = leaveType.replace('_', ' ').toUpperCase();
            alert(`âœ… Leave Request Submitted Successfully!\n\nðŸ“‹ Details:\nâ€¢ Type: ${leaveTypeDisplayName}\nâ€¢ From: ${fromDate}\nâ€¢ To: ${toDate}\nâ€¢ Status: ${result.message || 'Approved'}\n\nYour leave request has been processed.`);
            
            // Reset the form to initial state
            document.getElementById('addLeaveForm').reset();
            
            // Set today's date as default again
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('leaveFromDate').value = today;
            document.getElementById('leaveToDate').value = today;
            
            // Close the add leave modal
            const addLeaveModal = bootstrap.Modal.getInstance(document.getElementById('addLeaveModal'));
            if (addLeaveModal) {
              addLeaveModal.hide();
            }
            
            // Refresh the leave list immediately and also with a delay to ensure API processing
            if (window.loadUserLeaveData && window.currentLeaveUserId && window.currentLeaveUserType) {
              console.log('Refreshing leave list for user:', window.currentLeaveUserId);
              
              // Immediate refresh
              window.loadUserLeaveData(window.currentLeaveUserId, window.currentLeaveUserType);
              
              // Also refresh after a short delay to ensure the new record is available
              setTimeout(() => {
                console.log('Delayed refresh of leave list');
                window.loadUserLeaveData(window.currentLeaveUserId, window.currentLeaveUserType);
              }, 1000);
            } else {
              console.error('Unable to refresh leave list - missing context or function');
            }
          } else {
            alert(`âŒ Failed to Submit Leave Request\n\n${result.message || 'Unknown error occurred'}\n\nPlease try again or contact support if the problem persists.`);
          }
          
        } catch (error) {
          console.error('Error submitting leave request:', error);
          
          // Provide specific error messages
          let errorMessage = 'Failed to submit leave request.';
          if (error.message.includes('token')) {
            errorMessage = 'Authentication failed. Please login again.';
          } else if (error.message.includes('network') || error.message.includes('fetch')) {
            errorMessage = 'Network error. Please check your connection and try again.';
          } else if (error.message) {
            errorMessage = `Error: ${error.message}`;
          }
          
          alert(errorMessage);
        } finally {
          // Reset button state
          if (submitButton) {
            submitButton.innerHTML = '<i class="bi bi-calendar-plus me-2"></i>Submit Leave Request';
            submitButton.disabled = false;
          }
        }
      }

      // Remove the old mock data function since we're using real API now
      // function loadUserOvertimeData(userId, userType) { ... } - removed

      // Add overtime button functionality
      document.getElementById('addOvertimeBtn').addEventListener('click', function() {
        // Show the add overtime modal
        const addOvertimeModal = new bootstrap.Modal(document.getElementById('addOvertimeModal'));
        addOvertimeModal.show();
        
        // Set today's date as default
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('overtimeDate').value = today;
        
        // Clear form fields
        document.getElementById('overtimeDuration').value = '';
        document.getElementById('overtimeRemarks').value = '';
      });

      // Add overtime form submission
      document.getElementById('addOvertimeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const overtimeDate = document.getElementById('overtimeDate').value;
        const overtimeDuration = document.getElementById('overtimeDuration').value;
        const overtimeRemarks = document.getElementById('overtimeRemarks').value;
        
        // Validate form
        if (!overtimeDate) {
          alert('Please select an overtime date');
          return;
        }
        
        if (!overtimeDuration || overtimeDuration <= 0) {
          alert('Please enter a valid duration');
          return;
        }
        
        // Get current user context
        const userId = window.currentOvertimeUserId;
        const userType = window.currentOvertimeUserType;
        
        if (!userId || !userType) {
          alert('User context not found. Please close and reopen the overtime modal.');
          return;
        }
        
        // Prepare data for API
        const overtimeData = {
          date: overtimeDate,
          duration: parseFloat(overtimeDuration) * 60, // Convert hours to minutes
          remark: overtimeRemarks || '',
          status: 'approved'
        };
        
        // Add user_id or staff_id based on type
        if (userType === 'staff') {
          overtimeData.user_id = parseInt(userId);
        } else if (userType === 'worker') {
          overtimeData.staff_id = parseInt(userId);
        } else {
          alert('Invalid user type. Please try again.');
          return;
        }
        
        console.log('Submitting overtime data:', overtimeData);
        
        // Call API to save overtime
        saveOvertimeRecord(overtimeData);
      });

      // Function to save overtime record via API
      async function saveOvertimeRecord(overtimeData) {
        const saveButton = document.querySelector('#addOvertimeForm button[type="submit"]');
        
        try {
          // Show loading state
          const originalContent = saveButton.innerHTML;
          saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
          saveButton.disabled = true;

          // Use the API function from manage_overtime.js
          const result = await window.createOvertimeRecord(overtimeData);

          // Success feedback
          if (result && result.data) {
            alert(`Overtime record saved successfully!\n\nDetails:\n- Date: ${result.data.date}\n- Duration: ${result.data.duration} minutes\n- Status: ${result.data.status}`);
          } else {
            alert('Overtime record saved successfully!');
          }
          
          // Close the add overtime modal
          const addOvertimeModal = bootstrap.Modal.getInstance(document.getElementById('addOvertimeModal'));
          if (addOvertimeModal) {
            addOvertimeModal.hide();
          }
          
          // Refresh the overtime list
          if (window.loadUserOvertimeData && window.currentOvertimeUserId && window.currentOvertimeUserType) {
            window.loadUserOvertimeData(window.currentOvertimeUserId, window.currentOvertimeUserType);
          }
        } catch (error) {
          console.error('Error saving overtime:', error);
          
          // Provide specific error messages
          let errorMessage = 'Failed to save overtime record.';
          if (error.message.includes('token')) {
            errorMessage = 'Authentication failed. Please login again.';
          } else if (error.message.includes('network') || error.message.includes('fetch')) {
            errorMessage = 'Network error. Please check your connection and try again.';
          } else if (error.message) {
            errorMessage = `Error: ${error.message}`;
          }
          
          alert(errorMessage);
        } finally {
          // Reset button state
          if (saveButton) {
            saveButton.innerHTML = '<i class="bi bi-floppy me-2"></i>Save';
            saveButton.disabled = false;
          }
        }
      }

      // Edit overtime form submission
      document.getElementById('editOvertimeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const overtimeId = document.getElementById('editOvertimeId').value;
        const overtimeDate = document.getElementById('editOvertimeDate').value;
        const overtimeDuration = document.getElementById('editOvertimeDuration').value;
        const overtimeRemarks = document.getElementById('editOvertimeRemarks').value;
        
        // Validate form
        if (!overtimeDate) {
          alert('Please select an overtime date');
          return;
        }
        
        if (!overtimeDuration || overtimeDuration <= 0) {
          alert('Please enter a valid duration');
          return;
        }
        
        // Get current user context
        const userId = window.currentOvertimeUserId;
        const userType = window.currentOvertimeUserType;
        
        if (!userId || !userType) {
          alert('User context not found. Please close and reopen the overtime modal.');
          return;
        }
        
        // Prepare data for API
        const overtimeData = {
          id: parseInt(overtimeId),
          date: overtimeDate,
          duration: parseFloat(overtimeDuration) * 60, // Convert hours to minutes
          remark: overtimeRemarks || ''
        };
        
        // Add user_id or staff_id based on type
        if (userType === 'staff') {
          overtimeData.user_id = parseInt(userId);
        } else if (userType === 'worker') {
          overtimeData.staff_id = parseInt(userId);
        } else {
          alert('Invalid user type. Please try again.');
          return;
        }
        
        console.log('Updating overtime data:', overtimeData);
        
        // Call API to update overtime
        updateOvertimeRecord(overtimeData);
      });

      // Function to update overtime record via API
      async function updateOvertimeRecord(overtimeData) {
        const updateButton = document.querySelector('#editOvertimeForm button[type="submit"]');
        
        try {
          // Show loading state
          const originalContent = updateButton.innerHTML;
          updateButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
          updateButton.disabled = true;

          // Use the API function from manage_overtime.js
          const result = await window.updateOvertimeRecord(overtimeData);

          // Success feedback
          if (result && result.data) {
            alert(`Overtime record updated successfully!\n\nDetails:\n- Date: ${result.data.date_attendance?.date || 'N/A'}\n- Duration: ${result.data.duration} minutes\n- Status: ${result.data.status}`);
          } else {
            alert('Overtime record updated successfully!');
          }
          
          // Close the edit overtime modal
          const editOvertimeModal = bootstrap.Modal.getInstance(document.getElementById('editOvertimeModal'));
          if (editOvertimeModal) {
            editOvertimeModal.hide();
          }
          
          // Refresh the overtime list
          if (window.loadUserOvertimeData && window.currentOvertimeUserId && window.currentOvertimeUserType) {
            window.loadUserOvertimeData(window.currentOvertimeUserId, window.currentOvertimeUserType);
          }
        } catch (error) {
          console.error('Error updating overtime:', error);
          
          // Provide specific error messages
          let errorMessage = 'Failed to update overtime record.';
          if (error.message.includes('token')) {
            errorMessage = 'Authentication failed. Please login again.';
          } else if (error.message.includes('network') || error.message.includes('fetch')) {
            errorMessage = 'Network error. Please check your connection and try again.';
          } else if (error.message) {
            errorMessage = `Error: ${error.message}`;
          }
          
          alert(errorMessage);
        } finally {
          // Reset button state
          if (updateButton) {
            updateButton.innerHTML = '<i class="bi bi-floppy me-2"></i>Update';
            updateButton.disabled = false;
          }
        }
      }

      // Note: Filter functionality is now handled in manage_overtime.js

    })();
  </script>
</body>
</html>
